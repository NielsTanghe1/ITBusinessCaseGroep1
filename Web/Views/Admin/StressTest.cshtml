@{
	ViewData["Title"] = "Database Stress Test";
}

<div class="container py-4">
	<div class="d-flex align-items-center justify-content-between mb-4">
		<div>
			<h2 class="fw-bold mb-0">🔥 Database Stress Test</h2>
			<div class="text-muted small">Generate test users and orders to stress test the database</div>
		</div>
		<a asp-action="Index" class="btn btn-outline-secondary">← Back to Admin</a>
	</div>

	<div class="row g-4">
		<!-- Control Panel -->
		<div class="col-lg-4">
			<div class="card shadow-sm border-0 rounded-4">
				<div class="card-body p-4">
					<h5 class="fw-semibold mb-3">⚙️ Control Panel</h5>

					<div class="mb-3">
						<label class="form-label fw-semibold">Generation Interval (ms)</label>
						<input type="number" id="intervalInput" class="form-control" value="1000" min="100" max="10000" step="100" />
						<small class="text-muted">How fast to generate data (lower = faster)</small>
					</div>

					<div class="mb-3">
						<label class="form-label fw-semibold">Test Type</label>
						<select id="testType" class="form-select">
							<option value="users">Generate Users</option>
							<option value="orders">Generate Orders</option>
							<option value="both">Generate Both</option>
						</select>
					</div>

					<div class="d-grid gap-2">
						<button id="startBtn" class="btn btn-success btn-lg" onclick="startTest()">
							▶️ Start Test
						</button>
						<button id="stopBtn" class="btn btn-danger" onclick="stopTest()" disabled>
							⏸️ Stop Test
						</button>
						<button class="btn btn-warning" onclick="cleanupTestData()">
							🗑️ Cleanup Test Data
						</button>
					</div>

					<hr class="my-3" />

					<div class="text-center">
						<div class="badge bg-primary fs-6 px-3 py-2">
							Status: <span id="status">Idle</span>
						</div>
					</div>
				</div>
			</div>

			<!-- Warning Card -->
			<div class="card shadow-sm border-warning mt-3">
				<div class="card-body">
					<h6 class="text-warning mb-2">⚠️ Warning</h6>
					<small class="text-muted">
						This will generate real data in your database. 
						Use the cleanup function to remove test data (emails ending in @@test.com).
					</small>
				</div>
			</div>
		</div>

		<!-- Statistics -->
		<div class="col-lg-8">
			<div class="card shadow-sm border-0 rounded-4 mb-3">
				<div class="card-body p-4">
					<h5 class="fw-semibold mb-3">📊 Statistics</h5>
					
					<div class="row g-3">
						<div class="col-md-4">
							<div class="text-center p-3 bg-light rounded-3">
								<div class="fs-2 fw-bold text-primary" id="userCount">0</div>
								<div class="small text-muted">Users Generated</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="text-center p-3 bg-light rounded-3">
								<div class="fs-2 fw-bold text-success" id="orderCount">0</div>
								<div class="small text-muted">Orders Generated</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="text-center p-3 bg-light rounded-3">
								<div class="fs-2 fw-bold text-info" id="errorCount">0</div>
								<div class="small text-muted">Errors</div>
							</div>
						</div>
					</div>

					<div class="mt-3">
						<div class="d-flex justify-content-between align-items-center mb-2">
							<small class="text-muted">Elapsed Time</small>
							<span class="badge bg-secondary" id="elapsed">00:00:00</span>
						</div>
						<div class="d-flex justify-content-between align-items-center">
							<small class="text-muted">Operations/sec</small>
							<span class="badge bg-info" id="opsPerSec">0</span>
						</div>
					</div>
				</div>
			</div>

			<!-- Activity Log -->
			<div class="card shadow-sm border-0 rounded-4">
				<div class="card-body p-4">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h5 class="fw-semibold mb-0">📝 Activity Log</h5>
						<button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">Clear</button>
					</div>
					
					<div id="activityLog" class="border rounded-3 p-3" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; background-color: #f8f9fa;">
						<div class="text-muted">Waiting to start...</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		let intervalId = null;
		let startTime = null;
		let elapsedInterval = null;
		let userCount = 0;
		let orderCount = 0;
		let errorCount = 0;
		let totalOps = 0;

		const log = document.getElementById('activityLog');
		const statusEl = document.getElementById('status');
		const userCountEl = document.getElementById('userCount');
		const orderCountEl = document.getElementById('orderCount');
		const errorCountEl = document.getElementById('errorCount');
		const elapsedEl = document.getElementById('elapsed');
		const opsPerSecEl = document.getElementById('opsPerSec');
		const startBtn = document.getElementById('startBtn');
		const stopBtn = document.getElementById('stopBtn');

		function addLog(message, type = 'info') {
			const timestamp = new Date().toLocaleTimeString();
			const colors = {
				success: '#28a745',
				error: '#dc3545',
				info: '#17a2b8',
				warning: '#ffc107'
			};

			const entry = document.createElement('div');
			entry.style.color = colors[type];
			entry.innerHTML = `[${timestamp}] ${escapeHtml(message)}`;
			
			log.appendChild(entry);
			log.scrollTop = log.scrollHeight;
		}

		function clearLog() {
			log.innerHTML = '';
			addLog('Log cleared', 'info');
		}

		async function startTest() {
			const interval = parseInt(document.getElementById('intervalInput').value);
			const testType = document.getElementById('testType').value;

			userCount = 0;
			orderCount = 0;
			errorCount = 0;
			totalOps = 0;
			startTime = Date.now();

			startBtn.disabled = true;
			stopBtn.disabled = false;
			statusEl.textContent = 'Running';
			statusEl.parentElement.classList.remove('bg-primary', 'bg-danger');
			statusEl.parentElement.classList.add('bg-success');

			clearLog();
			addLog(`Starting ${testType} test with ${interval}ms interval`, 'success');

			// Start elapsed time counter
			elapsedInterval = setInterval(updateElapsedTime, 1000);

			intervalId = setInterval(async () => {
				if (testType === 'users' || testType === 'both') {
					await generateUser();
				}
				if (testType === 'orders' || testType === 'both') {
					await generateOrder();
				}
			}, interval);
		}

		function stopTest() {
			if (intervalId) {
				clearInterval(intervalId);
				intervalId = null;
			}
			if (elapsedInterval) {
				clearInterval(elapsedInterval);
				elapsedInterval = null;
			}

			startBtn.disabled = false;
			stopBtn.disabled = true;
			statusEl.textContent = 'Stopped';
			statusEl.parentElement.classList.remove('bg-success', 'bg-primary');
			statusEl.parentElement.classList.add('bg-danger');

			addLog('Test stopped', 'warning');
		}

		async function generateUser() {
			try {
				const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
				const response = await fetch('@Url.Action("GenerateTestUser")', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'RequestVerificationToken': token
					}
				});

				const data = await response.json();
				if (data.success) {
					userCount++;
					totalOps++;
					userCountEl.textContent = userCount;
					addLog(`✓ User created: ${data.name} (${data.email})`, 'success');
				} else {
					errorCount++;
					errorCountEl.textContent = errorCount;
					addLog(`✗ User creation failed: ${data.error}`, 'error');
				}
			} catch (error) {
				errorCount++;
				errorCountEl.textContent = errorCount;
				addLog(`✗ Error: ${error.message}`, 'error');
			}
		}

		async function generateOrder() {
			try {
				const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
				const response = await fetch('@Url.Action("GenerateTestOrder")', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'RequestVerificationToken': token
					}
				});

				const data = await response.json();
				if (data.success) {
					orderCount++;
					totalOps++;
					orderCountEl.textContent = orderCount;
					addLog(`✓ Order #${data.orderId} created with ${data.itemCount} items`, 'success');
				} else {
					errorCount++;
					errorCountEl.textContent = errorCount;
					addLog(`✗ Order creation failed: ${data.error}`, 'error');
				}
			} catch (error) {
				errorCount++;
				errorCountEl.textContent = errorCount;
				addLog(`✗ Error: ${error.message}`, 'error');
			}
		}

		async function cleanupTestData() {
			if (!confirm('This will delete ALL test users (emails ending in test.com) and their orders. Continue?')) {
				return;
			}

			addLog('Starting cleanup...', 'warning');
			
			try {
				const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
				const response = await fetch('@Url.Action("CleanupTestData")', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'RequestVerificationToken': token
					}
				});

				const data = await response.json();
				if (data.success) {
					addLog(`✓ Cleanup complete: ${data.deletedCount} test users deleted`, 'success');
					
					// Reset counters if test is not running
					if (!intervalId) {
						userCount = 0;
						orderCount = 0;
						errorCount = 0;
						userCountEl.textContent = '0';
						orderCountEl.textContent = '0';
						errorCountEl.textContent = '0';
					}
				} else {
					addLog(`✗ Cleanup failed: ${data.error}`, 'error');
				}
			} catch (error) {
				addLog(`✗ Error: ${error.message}`, 'error');
			}
		}

		function updateElapsedTime() {
			if (!startTime) return;
			
			const elapsed = Date.now() - startTime;
			const seconds = Math.floor(elapsed / 1000);
			const minutes = Math.floor(seconds / 60);
			const hours = Math.floor(minutes / 60);

			const displaySeconds = seconds % 60;
			const displayMinutes = minutes % 60;

			elapsedEl.textContent = 
				`${String(hours).padStart(2, '0')}:${String(displayMinutes).padStart(2, '0')}:${String(displaySeconds).padStart(2, '0')}`;

			// Calculate ops per second
			const opsPerSec = seconds > 0 ? (totalOps / seconds).toFixed(2) : '0';
			opsPerSecEl.textContent = opsPerSec;
		}

		function escapeHtml(str) {
			return (str ?? "")
				.toString()
				.replaceAll("&", "&amp;")
				.replaceAll("<", "&lt;")
				.replaceAll(">", "&gt;")
				.replaceAll('"', "&quot;")
				.replaceAll("'", "&#39;");
		}

		// Cleanup on page unload
		window.addEventListener('beforeunload', () => {
			if (intervalId) {
				stopTest();
			}
		});
	</script>

	@Html.AntiForgeryToken()
}