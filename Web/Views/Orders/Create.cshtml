@* @model Models.Entities.Order *@
@model Web.Models.OrderViewModel
@using Models.Data

@{
	ViewData["Title"] = "Create";
	// ViewData["Title"] = "Coffee Shop";
	var context = ViewBag.Context as LocalDbContext;
}

<div class="container py-4">

	<!-- HEADER -->
	<div class="shop-hero mb-4 d-flex justify-content-between align-items-center">
		<div>
			<h2 class="fw-bold mb-0">☕ Coffee Shop</h2>
			<div class="text-muted">Kies je koffie en bekijk je tas bovenaan</div>
		</div>

		<!-- CART DROPDOWN -->
		<div class="dropdown">
			<button id="cartBtn"
					  class="btn btn-outline-primary rounded-pill fw-bold position-relative px-3 dropdown-toggle"
					  type="button"
					  data-bs-toggle="dropdown"
					  data-bs-auto-close="outside">
				🛒 Tas
				<span id="cartCountBadge"
						class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
			</button>

			<div class="dropdown-menu dropdown-menu-end p-0 cart-dropdown">
				<div class="p-3 border-bottom">
					<div class="d-flex justify-content-between">
						<strong>Jouw tas</strong>
						<strong>€<span id="cartTotalTop">0.00</span></strong>
					</div>
				</div>

				<div id="cartEmpty" class="p-3 text-muted">
					Je tas is nog leeg.
				</div>

				<div id="cartList" class="d-none"></div>

				<div class="p-3 border-top d-flex gap-2">
					<button type="button" class="btn btn-outline-danger rounded-pill w-50" id="clearCartBtn">
						Leegmaken
					</button>
					<a href="#checkout" class="btn btn-success rounded-pill w-50">
						Checkout
					</a>
				</div>
			</div>
		</div>
	</div>

	<form id="orderForm" asp-action="Create" method="post" novalidate>
		@Html.AntiForgeryToken()

		<!-- PRODUCT GRID (3 naast elkaar) -->
		<div class="row g-4">
			@for (int i = 0; i < Model.Items.Count; i++) {
				var p = context.Coffees.First(x => x.Id == Model.Items[i].CoffeeId);

				<div class="col-6 col-md-4 col-lg-4">
					<div class="product-card h-100 js-product-card" data-product-id="@p.Id">
						@* <img src="@p.ImageUrl" alt="@p.Name" class="product-image" /> *@

						<div class="p-3">
							<div class="d-flex justify-content-between align-items-start">
								<div>
									<strong>@p.Name</strong>
									<div class="text-muted small">@p.Id</div>
								</div>
								<div class="price-pill">€@p.Price.ToString("0.00")</div>
							</div>

							<input type="hidden" asp-for="Items[@i].CoffeeId" />

							<div class="mt-2">
								<label class="form-label small">Aantal</label>
								<select class="form-select js-qty"
									asp-for="Items[@i].Quantity"
									data-name="@p.Name"
									data-price="@p.Price"
									data-product-id="@p.Id">
									<option value="0">0</option>
									@for (int q = 1; q <= 10; q++) {
										<option value="@q">@q</option>
									}
								</select>
							</div>

							<button type="button" class="btn btn-bag w-100 mt-3 js-add">
								👜 In tas
							</button>
						</div>
					</div>
				</div>
			}
		</div>

		<hr class="my-4" />

		<!-- CHECKOUT -->
		<div id="checkout" class="card p-4">
			<h5 class="fw-bold mb-3">Gegevens</h5>

			<div class="row g-3">
				<div class="col-md-4">
					<input class="form-control" asp-for="CoffeeUser.FirstName" placeholder="Voornaam" />
				</div>
				<div class="col-md-4">
					<input class="form-control" asp-for="CoffeeUser.LastName" placeholder="Achternaam" />
				</div>
				<div class="col-md-4">
					<input class="form-control" asp-for="CoffeeUser.Email" placeholder="Email" />
				</div>

				<div class="col-md-6">
					<input class="form-control" asp-for="Address.Street" placeholder="Straat + nr" />
				</div>
				<div class="col-md-3">
					<input class="form-control" asp-for="Address.HouseNumber" placeholder="Postbus" />
				</div>
				<div class="col-md-3">
					<input class="form-control" asp-for="Address.City" placeholder="Stad" />
				</div>
				<div class="col-md-3">
					<input class="form-control" asp-for="Address.PostalCode" placeholder="Postcode" />
				</div>
				<div class="col-md-9">
					<input class="form-control" asp-for="Address.CountryISO" placeholder="Land" />
				</div>
			</div>

			<button type="submit" class="btn btn-success btn-lg w-100 mt-4">
				✅ Bestelling plaatsen
			</button>
		</div>
	</form>
</div>

@section Scripts {
	<script>
		function money(n) { return (n || 0).toFixed(2); }

		function getItems() {
			return Array.from(document.querySelectorAll(".js-qty"))
				.map(s => {
					const q = parseInt(s.value || "0");
					const p = parseFloat(s.dataset.price || "0");
					return {
						id: s.dataset.productId,
						name: s.dataset.name,
						qty: q,
						total: q * p
					};
				})
				.filter(x => x.qty > 0);
		}

		function renderCart() {
			const items = getItems();
			const badge = document.getElementById("cartCountBadge");
			const totalEl = document.getElementById("cartTotalTop");
			const list = document.getElementById("cartList");
			const empty = document.getElementById("cartEmpty");

			badge.textContent = items.reduce((a, b) => a + b.qty, 0);
			totalEl.textContent = money(items.reduce((a, b) => a + b.total, 0));

			document.querySelectorAll(".js-product-card").forEach(c => {
				const pid = c.dataset.productId;
				c.classList.toggle("selected", items.some(i => i.id === pid));
			});

			if (items.length === 0) {
				empty.classList.remove("d-none");
				list.classList.add("d-none");
				list.innerHTML = "";
				return;
			}

			empty.classList.add("d-none");
			list.classList.remove("d-none");

			list.innerHTML = items.map(i => `
				<div class="cart-item">
					<strong>${i.name}</strong><br />
					<small>${i.qty} × €${money(i.total / i.qty)}</small>
					<div class="fw-bold">€${money(i.total)}</div>
				</div>
			`).join("");
		}

		document.querySelectorAll(".js-add").forEach(b => {
			b.addEventListener("click", () => {
				const sel = b.closest(".product-card").querySelector(".js-qty");
				if (sel.value === "0") sel.value = "1";
				renderCart();
				bootstrap.Dropdown.getOrCreateInstance(cartBtn).show();
			});
		});

		document.addEventListener("change", e => {
			if (e.target.classList.contains("js-qty")) renderCart();
		});

		document.getElementById("clearCartBtn").addEventListener("click", () => {
			document.querySelectorAll(".js-qty").forEach(s => s.value = "0");
			renderCart();
		});

		renderCart();
	</script>
	<script>
		document.getElementById("orderForm").addEventListener("submit", function (e) {
			const missing = [];

			// Minstens 1 product gekozen?
			const anyProduct = Array.from(document.querySelectorAll(".js-qty"))
				.some(q => parseInt(q.value || "0") > 0);

			if (!anyProduct) {
				missing.push("Kies minstens één product");
			}

			// Verplichte velden
			const requiredFields = [
				["FirstName", "Voornaam"],
				["LastName", "Achternaam"],
				["Email", "Email"],
				["Street", "Straat"],
				["Postbus", "Postbus"],
				["City", "Stad"],
				["Postcode", "Postcode"],
				["Country", "Land"]
			];

			for (const [id, label] of requiredFields) {
				const el = document.getElementById(id);
				if (!el || !el.value.trim()) {
					missing.push(label);
				}
			}

			// Popup tonen
			if (missing.length > 0) {
				e.preventDefault();
				alert(
					"Je bent het volgende vergeten in te vullen:\n\n" +
					"• " + missing.join("\n• ")
				);
			}
		});
	</script>
}

@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}
}
