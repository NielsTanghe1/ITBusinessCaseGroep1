@model Web.Models.PlaceOrderViewModel
@using Models.Data

@{
	ViewData["Title"] = "Bestelling plaatsen";
	var context = ViewBag.Context as LocalDbContext;
	var beans = context.Coffees.ToArray(); // lijst met bonen (Arabica/Robusta/...)
}

@*
<h1>Create</h1>

<h4>Order</h4>
<hr />
<div class="row">
	<div class="col-md-4">
		<form asp-action="Create">
			<div asp-validation-summary="ModelOnly" class="text-danger"></div>
			<input type="hidden" asp-for="CreatedAt" />
			<input type="hidden" asp-for="DeletedAt" />
			<div class="form-group">
				<label asp-for="CoffeeUserId" class="control-label"></label>
				<select asp-for="CoffeeUserId" class="form-control" asp-items="ViewBag.CoffeeUserId"></select>
			</div>
			<div class="form-group">
				<label asp-for="Status" class="control-label"></label>
				<select asp-for="Status" class="form-control" asp-items="ViewBag.StatusTypes"></select>
				<span asp-validation-for="Status" class="text-danger"></span>
			</div>
			<div class="form-group">
				<input type="submit" value="Create" class="btn btn-primary" />
			</div>
		</form>
	</div>
</div>

<div>
	<a asp-action="Index">Back to List</a>
</div>

@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}
}
*@


<div class="container py-4">

    <div class="d-flex align-items-center justify-content-between mb-3 gap-2 flex-wrap">
        <div>
            <h2 class="fw-bold mb-0">Shop</h2>
            <div class="text-muted small">Kies je bonen, type en aantal KG. Voeg toe aan je winkelmand.</div>
        </div>

        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="/">Terug</a>

            <!-- Winkelmand knop -->
            <button class="btn btn-dark position-relative" type="button"
                    data-bs-toggle="offcanvas" data-bs-target="#cartCanvas" aria-controls="cartCanvas">
                🛒 Winkelmand
                <span id="cartBadge"
                      class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                      style="display:none;">
                    0
                </span>
            </button>
        </div>
    </div>

    @if (TempData["OrderPlaced"] is string msg)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            @msg
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger shadow-sm">
            <strong>Controleer je invoer:</strong>
            <div asp-validation-summary="All"></div>
        </div>
    }

    <form id="orderForm" asp-action="Create" method="post" class="card shadow-sm border-0 rounded-4">
        @Html.AntiForgeryToken()

        <div class="card-body p-4">

            <!-- Hidden inputs die model binding doen -->
            @for (int i = 0; i < beans.Count(); i++)
            {
                var b = beans[i];
                <input type="hidden" name="Items[@i].BeanId" value="@b.Id" />
                <input type="hidden" id="roasted_@i" name="Items[@i].RoastedKg" value="0" />
                <input type="hidden" id="ground_@i" name="Items[@i].GroundKg" value="0" />
                <input type="hidden" id="raw_@i" name="Items[@i].RawKg" value="0" />
            }

            <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
                <h5 class="fw-semibold mb-0">Producten (per KG)</h5>
                <div class="text-muted small">
                    Subtotaal winkelmand: <span class="fw-semibold">€<span id="cartTotal">0.00</span></span>
                </div>
            </div>

            <!-- Product grid: 1 kolom mobiel, 2 op md, 3 op lg -->
            <div class="row g-3">
                @for (int i = 0; i < beans.Count(); i++)
                {
                    var b = beans[i];
                    @* var priceRoasted = context.Coffees.GetPricePerKg("Roasted", b.Id);
                    var priceGround = context.Coffees.GetPricePerKg("Ground", b.Id);
                    var priceRaw = context.Coffees.GetPricePerKg("Raw", b.Id); *@

                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="border rounded-4 p-3 h-100 d-flex flex-column">
                            <div class="d-flex align-items-start justify-content-between">
                                <div>
                                    <div class="fw-bold fs-5">@b.Name</div>
                                    <div class="text-muted small">@b.Id</div>
                                </div>
                                <span class="badge bg-light text-dark border">per KG</span>
                            </div>

                            <hr class="my-3" />

                            <!-- Type blocks -->
                            <div class="vstack gap-2">

                                <!-- Roasted -->
                                <div class="d-flex align-items-center justify-content-between gap-2">
                                    <div>
                                        <div class="fw-semibold">Roasted</div>
                                        <div class="text-muted small">€/kg</div> @* @priceRoasted.ToString("0.00") *@
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <select class="form-select form-select-sm qty"
                                                id="sel_roasted_@i"
                                                data-index="@i"
                                                data-type="Roasted"
                                                style="width: 84px;">
                                            @for (int kg = 1; kg <= 25; kg++)
                                            {
                                                <option value="@kg">@kg kg</option>
                                            }
                                        </select>

                                        <button type="button"
                                                class="btn btn-sm btn-success"
																onclick="addToCart(@i, 'Roasted', 'TOBEFIXED')"> @* @priceRoasted.ToString(System.Globalization.CultureInfo.InvariantCulture) *@
                                            + Toevoegen
                                        </button>
                                    </div>
                                </div>

                                <!-- Ground -->
                                <div class="d-flex align-items-center justify-content-between gap-2">
                                    <div>
                                        <div class="fw-semibold">Ground</div>
                                        <div class="text-muted small">€/kg</div> @* @priceGround.ToString("0.00") *@
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <select class="form-select form-select-sm qty"
                                                id="sel_ground_@i"
                                                data-index="@i"
                                                data-type="Ground"
                                                style="width: 84px;">
                                            @for (int kg = 1; kg <= 25; kg++)
                                            {
                                                <option value="@kg">@kg kg</option>
                                            }
                                        </select>

                                        <button type="button"
                                                class="btn btn-sm btn-success"
																onclick="addToCart(@i, 'Ground', 'TOBEFIXED')"> @* @priceGround.ToString(System.Globalization.CultureInfo.InvariantCulture) *@
                                            + Toevoegen
                                        </button>
                                    </div>
                                </div>

                                <!-- Raw -->
                                <div class="d-flex align-items-center justify-content-between gap-2">
                                    <div>
                                        <div class="fw-semibold">Raw</div>
                                        <div class="text-muted small">€/kg</div> @* @priceRaw.ToString("0.00") *@
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <select class="form-select form-select-sm qty"
                                                id="sel_raw_@i"
                                                data-index="@i"
                                                data-type="Raw"
                                                style="width: 84px;">
                                            @for (int kg = 1; kg <= 25; kg++)
                                            {
                                                <option value="@kg">@kg kg</option>
                                            }
                                        </select>

                                        <button type="button"
                                                class="btn btn-sm btn-success"
                                                onclick="addToCart(@i, 'Raw', 'TOBEFIXED')"> @* @priceRaw.ToString(System.Globalization.CultureInfo.InvariantCulture) *@
                                            + Toevoegen
                                        </button>
                                    </div>
                                </div>

                            </div>

                            <div class="mt-3 text-muted small">
                                In winkelmand:
                                <span class="fw-semibold" id="inCart_@i">0</span> kg totaal
                            </div>

                            <div class="mt-auto pt-2"></div>
                        </div>
                    </div>
                }
            </div>

            <hr class="my-4" />

            <h5 class="fw-semibold mb-3">Gegevens</h5>

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label" asp-for="FirstName"></label>
                    <input class="form-control" asp-for="FirstName" readonly />
                    <div class="text-danger small"><span asp-validation-for="FirstName"></span></div>
                </div>
                <div class="col-md-4">
                    <label class="form-label" asp-for="LastName"></label>
                    <input class="form-control" asp-for="LastName" readonly />
                    <div class="text-danger small"><span asp-validation-for="LastName"></span></div>
                </div>
                <div class="col-md-4">
                    <label class="form-label" asp-for="Email"></label>
                    <input class="form-control" asp-for="Email" type="email" readonly />
                    <div class="text-danger small"><span asp-validation-for="Email"></span></div>
                </div>

                <div class="col-md-6">
                    <label class="form-label" asp-for="Street"></label>
                    <input class="form-control" asp-for="Street" readonly />
                    <div class="text-danger small"><span asp-validation-for="Street"></span></div>
                </div>
                <div class="col-md-3">
                    <label class="form-label" asp-for="Postbus"></label>
                    <input class="form-control" asp-for="Postbus" readonly />
                    <div class="text-danger small"><span asp-validation-for="Postbus"></span></div>
                </div>
                <div class="col-md-3">
                    <label class="form-label" asp-for="City"></label>
                    <input class="form-control" asp-for="City" readonly />
                    <div class="text-danger small"><span asp-validation-for="City"></span></div>
                </div>

                <div class="col-md-3">
                    <label class="form-label" asp-for="Postcode"></label>
                    <input class="form-control" asp-for="Postcode" readonly />
                    <div class="text-danger small"><span asp-validation-for="Postcode"></span></div>
                </div>
                <div class="col-md-9">
                    <label class="form-label" asp-for="Country"></label>
                    <input class="form-control" asp-for="Country" readonly />
                    <div class="text-danger small"><span asp-validation-for="Country"></span></div>
                </div>
            </div>

            <button type="submit" class="btn btn-success btn-lg w-100 py-3 fw-semibold mt-4">
                Bestelling plaatsen
            </button>
        </div>
    </form>
</div>

<!-- Offcanvas winkelmand -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartCanvas" aria-labelledby="cartCanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title fw-bold" id="cartCanvasLabel">🛒 Winkelmand</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div id="cartEmpty" class="text-muted">
            Je winkelmand is leeg. Voeg producten toe.
        </div>

        <div id="cartList" class="vstack gap-2"></div>

        <hr class="my-3" />

        <div class="d-flex justify-content-between">
            <div class="fw-semibold">Totaal</div>
            <div class="fw-bold">€<span id="cartTotal2">0.00</span></div>
        </div>

        <div class="small text-muted mt-2">
            *De winkelmand vult automatisch de hidden inputs voor je order.
        </div>
    </div>
</div>

@section Scripts {
	<partial name="_ValidationScriptsPartial" />

	<script>
		// Cart opslag: key = `${index}|${type}` -> { index, type, beanName, beanId, kg, unitPrice }
		const cart = new Map();

		function beanNameByIndex(i) {
			 // neemt de titel uit de kaart
			 const el = document.querySelector(`#inCart_${i}`)?.closest(".border")?.querySelector(".fw-bold");
			 return el ? el.innerText.trim() : `Bean ${i}`;
		}

		function beanIdByIndex(i) {
			 // hidden input Items[i].BeanId
			 const hidden = document.querySelector(`input[name="Items[${i}].BeanId"]`);
			 return hidden ? hidden.value : "";
		}

		function setHiddenKg(i, type, kgTotalForType) {
			 if (type === "Roasted") document.getElementById(`roasted_${i}`).value = kgTotalForType;
			 if (type === "Ground")  document.getElementById(`ground_${i}`).value  = kgTotalForType;
			 if (type === "Raw")     document.getElementById(`raw_${i}`).value     = kgTotalForType;
		}

		function getHiddenKg(i, type) {
			 if (type === "Roasted") return parseInt(document.getElementById(`roasted_${i}`).value || "0");
			 if (type === "Ground")  return parseInt(document.getElementById(`ground_${i}`).value  || "0");
			 if (type === "Raw")     return parseInt(document.getElementById(`raw_${i}`).value     || "0");
			 return 0;
		}

		function addToCart(index, type, unitPrice) {
			 const typeLower = type.toLowerCase();
			 const sel = document.getElementById(`sel_${typeLower}_${index}`);
			 const kgToAdd = parseInt(sel?.value || "1");
			 const price = parseFloat(unitPrice);

			 const key = `${index}|${type}`;
			 const existing = cart.get(key);

			 const beanName = beanNameByIndex(index);
			 const beanId = beanIdByIndex(index);

			 const newKg = (existing?.kg || 0) + kgToAdd;

			 cart.set(key, {
				  index,
				  type,
				  beanName,
				  beanId,
				  kg: newKg,
				  unitPrice: price
			 });

			 // sync hidden field for this type (total kg for that type)
			 setHiddenKg(index, type, newKg);

			 renderCart();
		}

		function removeFromCart(index, type) {
			 const key = `${index}|${type}`;
			 cart.delete(key);

			 // hidden = 0 voor dat type
			 setHiddenKg(index, type, 0);

			 renderCart();
		}

		function changeKg(index, type, delta) {
			 const key = `${index}|${type}`;
			 const item = cart.get(key);
			 if (!item) return;

			 const next = item.kg + delta;
			 if (next <= 0) {
				  removeFromCart(index, type);
				  return;
			 }

			 item.kg = next;
			 cart.set(key, item);

			 setHiddenKg(index, type, next);
			 renderCart();
		}

		function renderCart() {
			 const list = document.getElementById("cartList");
			 const empty = document.getElementById("cartEmpty");

			 list.innerHTML = "";

			 let totalKgAll = 0;
			 let totalPrice = 0;

			 // per product kaart: update "in winkelmand" total kg
			 for (let i = 0; i < @beans.Count(); i++) {
				  const roasted = getHiddenKg(i, "Roasted");
				  const ground  = getHiddenKg(i, "Ground");
				  const raw     = getHiddenKg(i, "Raw");
				  const sum = roasted + ground + raw;
				  const label = document.getElementById(`inCart_${i}`);
				  if (label) label.innerText = sum.toString();
			 }

			 for (const [key, item] of cart.entries()) {
				  const lineTotal = item.kg * item.unitPrice;
				  totalKgAll += item.kg;
				  totalPrice += lineTotal;

				  const row = document.createElement("div");
				  row.className = "border rounded-4 p-3";

				  row.innerHTML = `
						<div class="d-flex justify-content-between align-items-start gap-2">
							 <div>
								  <div class="fw-semibold">${escapeHtml(item.type)} ${escapeHtml(item.beanName)}</div>
								  <div class="text-muted small">${escapeHtml(item.beanId)} • €${item.unitPrice.toFixed(2)}/kg</div>
							 </div>

							 <button type="button" class="btn btn-sm btn-outline-danger"
										onclick="removeFromCart(${item.index}, '${item.type}')">
								  Verwijder
							 </button>
						</div>

						<div class="d-flex justify-content-between align-items-center mt-2">
							 <div class="d-flex align-items-center gap-2">
								  <button type="button" class="btn btn-sm btn-outline-secondary"
											 onclick="changeKg(${item.index}, '${item.type}', -1)">-</button>
								  <div class="fw-semibold">${item.kg} kg</div>
								  <button type="button" class="btn btn-sm btn-outline-secondary"
											 onclick="changeKg(${item.index}, '${item.type}', 1)">+</button>
							 </div>

							 <div class="fw-bold">€${lineTotal.toFixed(2)}</div>
						</div>
				  `;

				  list.appendChild(row);
			 }

			 empty.style.display = cart.size === 0 ? "block" : "none";

			 // badge + total
			 const badge = document.getElementById("cartBadge");
			 if (totalKgAll > 0) {
				  badge.style.display = "inline-block";
				  badge.innerText = totalKgAll.toString();
			 } else {
				  badge.style.display = "none";
			 }

			 document.getElementById("cartTotal").innerText = totalPrice.toFixed(2);
			 document.getElementById("cartTotal2").innerText = totalPrice.toFixed(2);
		}

		// Basic required fields popup (zoals je eerder wou)
		document.getElementById("orderForm").addEventListener("submit", function (e) {
			 // minstens 1 item in mand (minstens 1 hidden > 0)
			 let hasAny = false;
			 for (let i = 0; i < @beans.Count(); i++) {
				  const sum =
						getHiddenKg(i, "Roasted") +
						getHiddenKg(i, "Ground") +
						getHiddenKg(i, "Raw");
				  if (sum > 0) { hasAny = true; break; }
			 }

			 const requiredIds = [
				  ["FirstName", "Voornaam"],
				  ["LastName", "Achternaam"],
				  ["Email", "Email"],
				  ["Street", "Straat"],
				  ["Postbus", "Postbus"],
				  ["City", "Stad"],
				  ["Postcode", "Postcode"],
				  ["Country", "Land"],
			 ];

			 const missing = [];
			 for (const [id, label] of requiredIds) {
				  const val = document.getElementById(id)?.value?.trim();
				  if (!val) missing.push(label);
			 }

			 if (!hasAny) missing.unshift("Minstens 1 product in winkelmand");

			 if (missing.length > 0) {
				  e.preventDefault();
				  alert("Je bent dit vergeten in te vullen:\n- " + missing.join("\n- "));
			 }
		});

		function escapeHtml(str) {
			 return (str ?? "")
				  .toString()
				  .replaceAll("&", "&amp;")
				  .replaceAll("<", "&lt;")
				  .replaceAll(">", "&gt;")
				  .replaceAll('"', "&quot;")
				  .replaceAll("'", "&#039;");
		}

		// init
		renderCart();
	</script>
}
